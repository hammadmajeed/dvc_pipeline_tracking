name: DVC Tracking with GitHub Actions

on: [push]

permissions:
  contents: write        # üëà allows creating branches, commits, and pushing
  pull-requests: write   # üëà allows opening/updating PRs

jobs:
  dvc-metrics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          make install

      - name: Run DVC pipeline
        run: |
          dvc repro

      - name: Generate metrics diff (Markdown)
        id: metrics
        run: |
          git fetch --prune
          echo "### DVC Metrics Diff" > metrics.md
          dvc metrics diff --md master >> metrics.md
          echo "" >> metrics.md

      - name: Generate DVC plots
        run: |
          dvc plots diff --target accuracy.json -o plots/plot.png
          git add plots
          git commit -m "Update DVC plots" || echo "No changes in plots"

      - name: Create or update Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}    # uses repo's auto-token
          title: "DVC: Metrics and Plots Update"
          body: |
            ## üìä DVC Metrics Diff
            $(cat metrics.md)

            ## üñºÔ∏è DVC Plot Preview
            ![DVC Plot](plots/plot.png)

          commit-message: "Auto-update DVC metrics and plots"
          branch: dvc-auto-update
          base: master
